{"ast":null,"code":"var _jsxFileName = \"/Users/seanjin/Documents/EBS/project/G1T3-frontend/client/components/upload/uploader.js\";\nvar __jsx = React.createElement;\nimport React, { useState } from \"react\";\nimport * as XLSX from \"xlsx\";\nimport DataTable from \"react-data-table-component\";\nimport { Clear } from \"@material-ui/icons\";\nexport default function Uploader() {\n  const {\n    0: columns,\n    1: setColumns\n  } = useState([]);\n  const {\n    0: data,\n    1: setData\n  } = useState([]);\n  const {\n    0: payload,\n    1: setPayload\n  } = useState([]);\n  const {\n    0: show,\n    1: setShow\n  } = useState(false);\n  const {\n    0: status,\n    1: setStatus\n  } = useState(null);\n  const {\n    0: error,\n    1: setError\n  } = useState(false);\n  const {\n    0: uploading,\n    1: setUploading\n  } = useState(false);\n  const ref = React.useRef(); // process CSV data\n\n  const processData = dataString => {\n    const dataStringLines = dataString.split(/\\r\\n|\\n/);\n    const headers = dataStringLines[0].split(/,(?![^\"]*\"(?:(?:[^\"]*\"){2})*[^\"]*$)/);\n    var check = ['postcode', 'householdSize', 'numWorkingAdults', 'noOfChildren'];\n    const list = [];\n\n    for (let i = 1; i < dataStringLines.length; i++) {\n      const row = dataStringLines[i].split(/,(?![^\"]*\"(?:(?:[^\"]*\"){2})*[^\"]*$)/);\n\n      if (headers && row.length == headers.length) {\n        const obj = {};\n\n        for (let j = 0; j < headers.length; j++) {\n          let d = row[j];\n\n          if (d.length > 0) {\n            if (d[0] == '\"') {\n              d = d.substring(1, d.length - 1);\n            }\n\n            if (d[d.length - 1] == '\"') {\n              d = d.substring(d.length - 2, 1);\n            }\n          }\n\n          if (headers[j]) {\n            if (check.includes(headers[j])) {\n              obj[headers[j]] = parseInt(d);\n            } else if (headers[j] == \"lastDelivery\" && d != \"\") {\n              d = new Date(d);\n              let year = d.getFullYear();\n              let date = `${d.getDate()}`.padStart(2, \"0\");\n              let month = `${d.getMonth() + 1}`.padStart(2, \"0\");\n              obj[headers[j]] = [year, month, date].join('-');\n            } else {\n              obj[headers[j]] = d;\n            }\n          }\n        }\n\n        if (Object.values(obj).filter(x => x).length > 0) {\n          let main = {\n            \"id\": JSON.stringify(i),\n            \"method\": \"POST\",\n            \"url\": \"/Beneficiary\",\n            \"headers\": {\n              \"content-type\": \"application/json; odata.metadata=minimal; odata.streaming=true\",\n              \"odata-version\": \"4.0\"\n            },\n            \"body\": obj\n          };\n          payload.push(main);\n          list.push(obj);\n        } // prepare columns list from headers\n\n\n        const columns = headers.map(c => ({\n          name: c,\n          selector: c\n        }));\n        setData(list);\n        setColumns(columns);\n      }\n    }\n\n    setPayload({\n      \"requests\": payload\n    });\n  }; // handle file upload\n\n\n  const handleFileUpload = e => {\n    const file = e.target.files[0];\n    const reader = new FileReader();\n\n    reader.onload = evt => {\n      /* Parse data */\n      const bstr = evt.target.result;\n      const wb = XLSX.read(bstr, {\n        type: \"binary\"\n      });\n      /* Get first worksheet */\n\n      const wsname = wb.SheetNames[0];\n      const ws = wb.Sheets[wsname];\n      /* Convert array of arrays */\n\n      const data = XLSX.utils.sheet_to_csv(ws, {\n        header: 1\n      });\n      processData(data);\n    };\n\n    reader.readAsBinaryString(file);\n  };\n\n  const submitPayload = async () => {\n    setUploading(true);\n    let url = 'https://cors-anywhere.herokuapp.com/https://smucf-dev-ebs-g1t3-srv.cfapps.us10.hana.ondemand.com/api/$batch'; // let url = 'https://cors-anywhere.herokuapp.com/http://localhost:4004/api/$batch';\n\n    const requestOptions = {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify(payload)\n    };\n\n    try {\n      console.log(\"attempting to send data\");\n      const response = await fetch(url, requestOptions);\n      const data = await response.json();\n      console.log(\"data :\" + JSON.stringify(data));\n\n      if (response.ok) {\n        let status = data['responses'][0]['status'];\n\n        if (status > 299) {\n          console.log(\"Problem uploading data\");\n          setError(true);\n          setStatus('Input in wrong format!\\n' + 'Ensure ints are int, strings are string, date in YYYY-MM-DD format!\\n' + 'Or data might already exist!');\n        } else {\n          console.log(\"Succesfully uploaded data\");\n          setShow(true);\n          setStatus('Successfully uploaded data');\n        }\n      } else {\n        console.log(\"Problem uploading data\");\n        setError(true);\n        setStatus('Problem uploading data');\n      }\n    } catch (error) {\n      console.log(\"Error :\" + error);\n      setError(true);\n      setStatus('Server might be down!');\n    }\n\n    setUploading(false);\n  };\n\n  const clearData = () => {\n    ref.current.value = \"\";\n    setData([]);\n    setColumns([]);\n    setPayload([]);\n    setShow(false);\n    setStatus(null);\n    setError(false);\n    setUploading(false);\n  };\n\n  const UploadInput = () => {\n    return __jsx(\"button\", {\n      id: \"upload\",\n      name: \"upload\",\n      className: \"cursor-pointer hover:bg-gray-600 py-1 px-4 rounded focus:outline-none focus:shadow-outline ml-4 border border-black\",\n      onClick: submitPayload,\n      disabled: uploading,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 170,\n        columnNumber: 7\n      }\n    }, uploading ? \"Uploading data...\" : \"Upload data\");\n  };\n\n  const ClearInput = () => {\n    return __jsx(\"button\", {\n      type: \"submit\",\n      id: \"clear\",\n      name: \"clear\",\n      value: \"Clear data\",\n      className: \"cursor-pointer hover:bg-gray-600 py-1 px-4 rounded focus:outline-none focus:shadow-outline ml-4 border border-black\",\n      onClick: clearData,\n      disabled: uploading,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 182,\n        columnNumber: 7\n      }\n    }, \"Clear Data\");\n  };\n\n  const close = () => {\n    setError(false);\n    setShow(false);\n  };\n\n  const GreenAlert = () => {\n    return __jsx(\"div\", {\n      className: \"w-2/4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4\",\n      role: \"alert\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 199,\n        columnNumber: 7\n      }\n    }, __jsx(\"span\", {\n      className: \"block sm:inline\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 203,\n        columnNumber: 9\n      }\n    }, \" \", status, \"  \"), __jsx(\"span\", {\n      className: \"absolute top-0 bottom-0 right-0 px-4 py-3\",\n      onClick: close,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 204,\n        columnNumber: 9\n      }\n    }, __jsx(\"svg\", {\n      className: \"fill-current h-6 w-6 text-green-500\",\n      role: \"button\",\n      xmlns: \"http://www.w3.org/2000/svg\",\n      viewBox: \"0 0 20 20\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 208,\n        columnNumber: 11\n      }\n    }, __jsx(\"title\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 214,\n        columnNumber: 13\n      }\n    }, \"Close\"), __jsx(\"path\", {\n      d: \"M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 215,\n        columnNumber: 13\n      }\n    }))));\n  };\n\n  const RedAlert = () => {\n    return __jsx(\"div\", {\n      className: \"w-2/4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4\",\n      role: \"alert\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 224,\n        columnNumber: 7\n      }\n    }, __jsx(\"span\", {\n      className: \"block sm:inline\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 228,\n        columnNumber: 9\n      }\n    }, status), __jsx(\"span\", {\n      className: \"absolute top-0 bottom-0 right-0 px-4 py-3\",\n      onClick: close,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 229,\n        columnNumber: 9\n      }\n    }, __jsx(\"svg\", {\n      className: \"fill-current h-6 w-6 text-red-500\",\n      role: \"button\",\n      xmlns: \"http://www.w3.org/2000/svg\",\n      viewBox: \"0 0 20 20\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 233,\n        columnNumber: 11\n      }\n    }, __jsx(\"title\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 239,\n        columnNumber: 13\n      }\n    }, \"Close\"), __jsx(\"path\", {\n      d: \"M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 240,\n        columnNumber: 13\n      }\n    }))));\n  };\n\n  return __jsx(\"div\", {\n    className: \"container mx-auto px-4 sm:px-8 mt-18 flex-grow h-full\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 248,\n      columnNumber: 5\n    }\n  }, __jsx(\"div\", {\n    className: \"py-8 flex-grow flex-col flex bg-white shadow-lg rounded px-8 pt-6 pb-8 mb-4 mt-4 h-auto items-center\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 249,\n      columnNumber: 7\n    }\n  }, show ? __jsx(GreenAlert, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 251,\n      columnNumber: 18\n    }\n  }) : null, error ? __jsx(RedAlert, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 252,\n      columnNumber: 19\n    }\n  }) : null, __jsx(\"h1\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 254,\n      columnNumber: 9\n    }\n  }, __jsx(\"b\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 255,\n      columnNumber: 11\n    }\n  }, \"Upload CSV file of beneficiaries\")), __jsx(\"div\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 258,\n      columnNumber: 9\n    }\n  }, __jsx(\"input\", {\n    type: \"file\",\n    accept: \".csv,.xlsx,.xls\",\n    className: \"cursor-pointer hover:bg-gray-600 py-4 px-4 rounded focus:outline-none focus:shadow-outline mx-auto\",\n    ref: ref,\n    onChange: handleFileUpload,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 259,\n      columnNumber: 9\n    }\n  }), data.length > 0 ? __jsx(UploadInput, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 266,\n      columnNumber: 28\n    }\n  }) : __jsx(React.Fragment, null), data.length > 0 ? __jsx(ClearInput, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 267,\n      columnNumber: 28\n    }\n  }) : __jsx(React.Fragment, null)), __jsx(DataTable, {\n    pagination: true,\n    highlightOnHover: true,\n    columns: columns,\n    data: data,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 270,\n      columnNumber: 9\n    }\n  })));\n}\n;","map":{"version":3,"sources":["/Users/seanjin/Documents/EBS/project/G1T3-frontend/client/components/upload/uploader.js"],"names":["React","useState","XLSX","DataTable","Clear","Uploader","columns","setColumns","data","setData","payload","setPayload","show","setShow","status","setStatus","error","setError","uploading","setUploading","ref","useRef","processData","dataString","dataStringLines","split","headers","check","list","i","length","row","obj","j","d","substring","includes","parseInt","Date","year","getFullYear","date","getDate","padStart","month","getMonth","join","Object","values","filter","x","main","JSON","stringify","push","map","c","name","selector","handleFileUpload","e","file","target","files","reader","FileReader","onload","evt","bstr","result","wb","read","type","wsname","SheetNames","ws","Sheets","utils","sheet_to_csv","header","readAsBinaryString","submitPayload","url","requestOptions","method","body","console","log","response","fetch","json","ok","clearData","current","value","UploadInput","ClearInput","close","GreenAlert","RedAlert"],"mappings":"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","sourcesContent":["import React, { useState } from \"react\";\nimport * as XLSX from \"xlsx\";\nimport DataTable from \"react-data-table-component\";\nimport { Clear } from \"@material-ui/icons\";\n\nexport default function Uploader() {\n\n  const [columns, setColumns] = useState([]);\n  const [data, setData] = useState([]);\n  const [payload, setPayload] = useState([]);\n\n  const [show, setShow] = useState(false);\n  const [status, setStatus] = useState(null);\n  const [error, setError] = useState(false);\n  const [uploading, setUploading] = useState(false);\n\n  const ref = React.useRef();\n\n  // process CSV data\n  const processData = (dataString) => {\n    const dataStringLines = dataString.split(/\\r\\n|\\n/);\n    const headers = dataStringLines[0].split(\n      /,(?![^\"]*\"(?:(?:[^\"]*\"){2})*[^\"]*$)/\n    );\n    \n    var check = ['postcode', 'householdSize', 'numWorkingAdults','noOfChildren'];\n    const list = [];\n    for (let i = 1; i < dataStringLines.length; i++) {\n      const row = dataStringLines[i].split(\n        /,(?![^\"]*\"(?:(?:[^\"]*\"){2})*[^\"]*$)/\n      );\n      if (headers && row.length == headers.length) {\n        const obj = {};\n        for (let j = 0; j < headers.length; j++) {\n          let d = row[j];\n          if (d.length > 0) {\n            if (d[0] == '\"') {\n              d = d.substring(1, d.length - 1);\n            }\n            if (d[d.length - 1] == '\"') {\n              d = d.substring(d.length - 2, 1);\n            }\n          }\n\n          if (headers[j]) {\n            if (check.includes(headers[j])) {\n              obj[headers[j]] = parseInt(d);\n            } \n            else if (headers[j] == \"lastDelivery\" && d != \"\") {\n              d = new Date(d);\n              let year = d.getFullYear();\n              let date = `${d.getDate()}`.padStart(2, \"0\")\n              let month = `${d.getMonth() + 1}`.padStart(2, \"0\")\n              obj[headers[j]] = [year, month, date].join('-');\n            }\n            else {\n              obj[headers[j]] = d;\n            }\n          }\n        }\n\n        if (Object.values(obj).filter((x) => x).length > 0) {\n          let main = {\n            \"id\": JSON.stringify(i),\n            \"method\": \"POST\",\n            \"url\": \"/Beneficiary\",\n            \"headers\": {\n                \"content-type\": \"application/json; odata.metadata=minimal; odata.streaming=true\",\n                \"odata-version\": \"4.0\"\n            },\n            \"body\": obj\n          }\n          payload.push(main);\n          list.push(obj);\n        }\n\n        // prepare columns list from headers\n        const columns = headers.map((c) => ({\n          name: c,\n          selector: c,\n        }));\n\n        setData(list);\n        setColumns(columns);\n      }\n    }\n    setPayload({\n      \"requests\": payload\n    });\n  };\n\n  // handle file upload\n  const handleFileUpload = (e) => {\n    const file = e.target.files[0];\n    const reader = new FileReader();\n    reader.onload = (evt) => {\n      /* Parse data */\n      const bstr = evt.target.result;\n      const wb = XLSX.read(bstr, { type: \"binary\" });\n      /* Get first worksheet */\n      const wsname = wb.SheetNames[0];\n      const ws = wb.Sheets[wsname];\n      /* Convert array of arrays */\n      const data = XLSX.utils.sheet_to_csv(ws, { header: 1 });\n\n      processData(data);\n    };\n    reader.readAsBinaryString(file);\n  };\n\n  const submitPayload = async () => {\n    setUploading(true);\n\n    let url = 'https://cors-anywhere.herokuapp.com/https://smucf-dev-ebs-g1t3-srv.cfapps.us10.hana.ondemand.com/api/$batch';\n    // let url = 'https://cors-anywhere.herokuapp.com/http://localhost:4004/api/$batch';\n\n    const requestOptions = {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify(payload)\n    };\n\n    try {\n      console.log(\"attempting to send data\");\n\n      const response = await fetch(url, requestOptions);\n      const data = await response.json();\n      console.log(\"data :\" +JSON.stringify(data));\n\n      if (response.ok) {\n        let status = data['responses'][0]['status'];\n        if (status > 299) {\n          console.log(\"Problem uploading data\");\n          setError(true);\n          setStatus('Input in wrong format!\\n' + 'Ensure ints are int, strings are string, date in YYYY-MM-DD format!\\n'+'Or data might already exist!');\n        }\n        else {\n\n          console.log(\"Succesfully uploaded data\");\n          setShow(true);\n          setStatus('Successfully uploaded data');\n        }\n      }\n      else {\n        console.log(\"Problem uploading data\");\n        setError(true);\n        setStatus('Problem uploading data');\n      }\n    } catch (error) {\n      console.log(\"Error :\"+error);\n      setError(true);\n      setStatus('Server might be down!');\n    }\n    setUploading(false);\n  }\n\n  const clearData = () => {\n    ref.current.value = \"\"\n    setData([]);\n    setColumns([]);\n    setPayload([]);\n    setShow(false);\n    setStatus(null);\n    setError(false);\n    setUploading(false);\n  }\n\n  const UploadInput = () => {\n    return (\n      <button\n        id=\"upload\" name=\"upload\" \n        className=\"cursor-pointer hover:bg-gray-600 py-1 px-4 rounded focus:outline-none focus:shadow-outline ml-4 border border-black\"\n        onClick={submitPayload} disabled={uploading} \n      >\n        {uploading ? \"Uploading data...\" : \"Upload data\"}\n      </button>\n    )\n  }\n\n  const ClearInput = () => {\n    return (\n      <button\n        type=\"submit\" id=\"clear\" name=\"clear\" value=\"Clear data\"\n        className=\"cursor-pointer hover:bg-gray-600 py-1 px-4 rounded focus:outline-none focus:shadow-outline ml-4 border border-black\"\n        onClick={clearData} disabled={uploading} \n      >\n        Clear Data\n      </button>\n    )\n  }\n\n  const close = () => {\n    setError(false);\n    setShow(false);\n  }\n\n  const GreenAlert = () => {\n    return (\n      <div\n        className='w-2/4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4'\n        role='alert'\n      >\n        <span className='block sm:inline'> {status}  </span>\n        <span\n          className='absolute top-0 bottom-0 right-0 px-4 py-3'\n          onClick={close}\n        >\n          <svg\n            className='fill-current h-6 w-6 text-green-500'\n            role='button'\n            xmlns='http://www.w3.org/2000/svg'\n            viewBox='0 0 20 20'\n          >\n            <title>Close</title>\n            <path d='M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z' />\n          </svg>\n        </span>\n      </div>\n    )\n  }\n\n  const RedAlert = () => {\n    return (\n      <div\n        className='w-2/4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4'\n        role='alert'\n      >\n        <span className='block sm:inline'>{status}</span>\n        <span\n          className='absolute top-0 bottom-0 right-0 px-4 py-3'\n          onClick={close} \n        > \n          <svg\n            className='fill-current h-6 w-6 text-red-500'\n            role='button'\n            xmlns='http://www.w3.org/2000/svg'\n            viewBox='0 0 20 20'\n          >\n            <title>Close</title>\n            <path d='M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z' />\n          </svg>\n        </span>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"container mx-auto px-4 sm:px-8 mt-18 flex-grow h-full\">\n      <div className=\"py-8 flex-grow flex-col flex bg-white shadow-lg rounded px-8 pt-6 pb-8 mb-4 mt-4 h-auto items-center\">\n\n        { show ? <GreenAlert /> : null }\n        { error ? <RedAlert /> : null }\n\n        <h1>\n          <b>Upload CSV file of beneficiaries</b>\n        </h1>\n\n        <div>\n        <input\n          type=\"file\"\n          accept=\".csv,.xlsx,.xls\"\n          className=\"cursor-pointer hover:bg-gray-600 py-4 px-4 rounded focus:outline-none focus:shadow-outline mx-auto\"\n          ref={ref}\n          onChange={handleFileUpload}\n        />\n        {data.length > 0 ? <UploadInput/> : <></>}\n        {data.length > 0 ? <ClearInput/> : <></>}\n        </div>\n\n        <DataTable pagination highlightOnHover columns={columns} data={data} />\n      </div>\n    </div>\n  );\n};"]},"metadata":{},"sourceType":"module"}